name: Deploy Flutter Web to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        # –í–ê–ñ–ù–û: –£–∫–∞–∑—ã–≤–∞–µ–º –±–æ–ª–µ–µ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é Flutter
        flutter-version: '3.22.0'  # –≠—Ç–∞ –≤–µ—Ä—Å–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç Dart 3.7.0+
    
    - name: Show versions for debug
      run: |
        echo "=== Installed versions ==="
        flutter --version
        dart --version
        echo ""
        echo "=== Flutter doctor ==="
        flutter doctor -v
    
    - name: Install dependencies
      run: |
        echo "üîÑ Installing dependencies..."
        flutter pub get
    
    - name: Fix base href
      run: |
        # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ base href –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
        if [ -f "web/index.html" ]; then
          sed -i 's|<base href="\$FLUTTER_BASE_HREF">|<base href="/mtg_stats/">|g' web/index.html
          echo "‚úÖ Base href fixed"
          grep "base href" web/index.html
        else
          echo "‚ö†Ô∏è web/index.html not found"
        fi
    
    - name: Build Flutter Web
      run: |
        echo "üèóÔ∏è Building Flutter Web..."
        flutter build web \
          --release \
          --base-href /mtg_stats/ \
          --verbose 2>&1 | grep -A5 -B5 "error\|Error\|failed\|Failed" || true
    
    - name: Check build output
      run: |
        echo "üìÅ Build directory content:"
        ls -la build/web/
        echo ""
        if [ -f "build/web/main.dart.js" ]; then
          echo "‚úÖ main.dart.js found! Size: $(du -h build/web/main.dart.js | cut -f1)"
        else
          echo "‚ùå main.dart.js NOT FOUND!"
          echo "Listing all .js files:"
          find build/web -name "*.js" -type f
        fi
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './build/web'
    
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4