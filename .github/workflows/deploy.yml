name: Deploy Flutter Web to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        flutter-version: '3.38.5'
    
    - name: Show versions for debug
      run: |
        echo "=== Installed versions ==="
        flutter --version
        dart --version
        echo ""
    
    - name: Enable web platform
      run: |
        echo "üîÑ Enabling web platform..."
        flutter config --enable-web
        # –°–æ–∑–¥–∞–µ–º web –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
        if [ ! -d "web" ]; then
          echo "Creating web platform..."
          flutter create --platforms=web .
        else
          echo "Web platform already exists"
        fi
    
    - name: Debug - Check project structure
      run: |
        echo "=== Project structure ==="
        pwd
        ls -la
        echo ""
        echo "=== web/ directory ==="
        ls -la web/
        echo ""
        echo "=== lib/ directory ==="
        ls -la lib/
        echo ""
        echo "=== pubspec.yaml (first 30 lines) ==="
        head -30 pubspec.yaml
    
    - name: Install dependencies
      run: |
        echo "üîÑ Installing dependencies..."
        # –û—á–∏—â–∞–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–Ω–æ–≤–æ
        rm -f pubspec.lock
        flutter clean
        flutter pub get --verbose 2>&1 | tail -50
    
    - name: Fix base href
      run: |
        echo "üîß Fixing base href..."
        if [ -f "web/index.html" ]; then
          # –°–æ–∑–¥–∞–µ–º backup
          cp web/index.html web/index.html.backup
          # –ó–∞–º–µ–Ω—è–µ–º base href
          sed -i 's|<base href="\$FLUTTER_BASE_HREF">|<base href="/mtg_stats/">|g' web/index.html
          echo "‚úÖ Base href fixed:"
          grep "base href" web/index.html
        else
          echo "‚ùå web/index.html not found! Creating basic one..."
          cat > web/index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
  <base href="/mtg_stats/">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MTG Stats</title>
</head>
<body>
  <script src="flutter.js" defer></script>
  <script src="main.dart.js" type="application/javascript"></script>
</body>
</html>
EOF
          echo "‚úÖ Created basic index.html"
        fi
    
    - name: Build Flutter Web
      run: |
        echo "üèóÔ∏è Building Flutter Web..."
        echo "Command: flutter build web --release --base-href /mtg_stats/"
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—ã–π –ª–æ–≥
        flutter build web \
          --release \
          --base-href /mtg_stats/ 2>&1 | tee build_output.txt
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        BUILD_STATUS=$?
        echo "Build exit code: $BUILD_STATUS"
        
        echo "=== Last 100 lines of build output ==="
        tail -100 build_output.txt
        
        if [ $BUILD_STATUS -ne 0 ]; then
          echo "‚ùå Build failed! Showing errors:"
          grep -i "error\|failed\|exception\|unhandled" build_output.txt | head -20
          echo ""
          echo "For full log, check build_output.txt"
          exit 1
        fi
        
        echo "‚úÖ Build completed successfully"
    
    - name: Check build output
      run: |
        echo "üìÅ Checking build output..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–∞–ø–∫–∏ build/web
        if [ -d "build/web" ]; then
          echo "‚úÖ build/web directory exists"
          echo "=== Files in build/web ==="
          ls -la build/web/
          echo ""
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã
          if [ -f "build/web/main.dart.js" ]; then
            echo "‚úÖ main.dart.js found ($(du -h "build/web/main.dart.js" | cut -f1))"
          else
            echo "‚ùå main.dart.js NOT FOUND!"
          fi
          
          if [ -f "build/web/index.html" ]; then
            echo "‚úÖ index.html found ($(du -h "build/web/index.html" | cut -f1))"
          else
            echo "‚ùå index.html NOT FOUND!"
          fi
          
          if [ -f "build/web/flutter.js" ]; then
            echo "‚úÖ flutter.js found ($(du -h "build/web/flutter.js" | cut -f1))"
          else
            echo "‚ùå flutter.js NOT FOUND!"
          fi
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—á–∞–ª–æ index.html
          echo ""
          echo "=== First 15 lines of build/web/index.html ==="
          head -15 build/web/index.html
          
        else
          echo "‚ùå build/web directory does NOT exist!"
          echo "Checking if build directory exists:"
          ls -la build/ 2>/dev/null || echo "No build directory at all"
          exit 1
        fi
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './build/web'
    
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4